{{ $images := .Inner | transform.Unmarshal }}

<div class="justified-gallery">
  {{ range $images }}
    {{/* Use the more flexible GetMatch to find the image in /assets */}}
    {{ $original := resources.GetMatch .src }}

    {{ if $original }}
      {{/* Process the image for the thumbnail */}}
      {{ $thumb := ($original.Resize "x360").Process "webp q50" }}

      {{/* Link to the ORIGINAL image for the lightbox */}}
      <a href="{{ $original.RelPermalink }}" {{ with .caption }}title="{{ . }}"{{ end }}>
        {{/* Display the processed WEBP thumbnail */}}
        <img src="{{ $thumb.RelPermalink }}" 
             width="{{ $thumb.Width }}" 
             height="{{ $thumb.Height }}" 
             loading="lazy" 
             alt="{{ .alt | default "Image" }}">
      </a>
    {{ else }}
      {{ end }}
  {{ end }}
</div>

{{/* This part loads the required JS/CSS only once per page */}}
{{ if not (.Page.Scratch.Get "gal-loaded") }}
  {{ .Page.Scratch.Set "gal-loaded" true }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery.min.css">
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.umd.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const galleries = document.querySelectorAll('.justified-gallery');
      galleries.forEach(gallery => {
        $(gallery).justifiedGallery({
          rowHeight: 180,
          margins: 5,
          captions: true
        }).on('jg.complete', function () {
          lightGallery(gallery, {
            selector: 'a',
            download: false
          });
        });
      });
    });
  </script>
{{ end }}