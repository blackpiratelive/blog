{{ $images := .Inner | transform.Unmarshal }}

<div class="justified-gallery">
  {{ range $images }}
    {{/* Get the path from the "src" key and remove the leading "/" */}}
    {{ $path := .src | strings.TrimPrefix "/" }}
    {{/* Find the original image in the /assets folder using the cleaned path */}}
    {{ $original := resources.Get $path }}

    {{ if $original }}
      {{/* Process the image for the thumbnail:
        1. Resize it to a height of 360px.
        2. Convert to WebP format at 50% quality.
      */}}
      {{ $thumb := ($original.Resize "x360").Process "webp q50" }}

      {{/* The <a> link points to the ORIGINAL image for the lightbox */}}
      <a href="{{ $original.RelPermalink }}" {{ with .caption }}title="{{ . }}"{{ end }}>
        {{/* The <img> tag displays the processed WEBP thumbnail */}}
        <img src="{{ $thumb.RelPermalink }}" 
             width="{{ $thumb.Width }}" 
             height="{{ $thumb.Height }}" 
             loading="lazy" 
             alt="{{ .alt | default "Image" }}">
      </a>
    {{ else }}
      {{/* Output a comment in the HTML if an image can't be found */}}
      {{ end }}
  {{ end }}
</div>

{{/* This part remains the same: it loads the required JS/CSS only once per page */}}
{{ if not (.Page.Scratch.Get "gal-loaded") }}
  {{ .Page.Scratch.Set "gal-loaded" true }}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/css/lightgallery.min.css">
  <script src="https://cdn.jsdelivr.net/npm/lightgallery@2.7.1/lightgallery.umd.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const galleries = document.querySelectorAll('.justified-gallery');
      galleries.forEach(gallery => {
        $(gallery).justifiedGallery({
          rowHeight: 180,
          margins: 5,
          captions: true
        }).on('jg.complete', function () {
          lightGallery(gallery, {
            selector: 'a',
            download: false
          });
        });
      });
    });
  </script>
{{ end }}